#include <Arduino.h>
#include <freertos/FreeRTOS.h>
#include <freertos/task.h>
#include <freertos/semphr.h>
#include "processData.h"
#include "blink.h"  // Include your custom header file

// Buffer to store incoming serial data
#define BUFFER_SIZE 256
char serialBuffer[BUFFER_SIZE];
int bufferIndex = 0;

// Mutex to protect access to the serialBuffer
SemaphoreHandle_t mutex;

void setup() {
  Serial.begin(115200);

  // Create the mutex
  mutex = xSemaphoreCreateMutex();
  if (mutex == NULL) {
    Serial.println("Mutex creation failed!");
    while (true);
  }

  initProcessData();
  initBlinkTask();

}

void loop() {
  while (Serial.available()) {
    char incomingByte = Serial.read();
        
    if (xSemaphoreTake(mutex, portMAX_DELAY) == pdTRUE) {
      if (bufferIndex < BUFFER_SIZE - 1) {
	serialBuffer[bufferIndex++] = incomingByte;
	if (incomingByte == '\n') {
	  serialBuffer[bufferIndex] = '\0'; 
	  bufferIndex = 0;
	}
      }
      xSemaphoreGive(mutex);
    }
  }
}

